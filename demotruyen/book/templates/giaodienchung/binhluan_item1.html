<div class="mt-3 ms-{{ margin|default:4 }} p-2 border rounded bg-white">
    {% if binhluan.user.thong_tin_nguoi_dung.anh_dai_dien %}
        <img src="{{ binhluan.user.thong_tin_nguoi_dung.anh_dai_dien.url }}" class="img-fluid rounded-circle" width="50">
    {% else %}
        <img src="/static/images/default-avatar.png" class="img-fluid rounded-circle" width="40">
    {% endif %}

    <strong>{{ binhluan.user.username }}</strong>

    <small class="text-muted"> - {{ binhluan.thoigian_danhgia|date:"d/m/Y H:i" }}
         {% if binhluan.capnhat %}
        <span class="text-muted">- </span>
        <span class="text-muted">Cập nhật: </span>
        <span class="text-muted">{{ binhluan.capnhat|date:"d/m/Y H:i" }}</span>
        {% else %}
        <span class="text-muted">- Chưa cập nhật</span>
        {% endif %}
        <!--
        <em>(Đã chỉnh sửa: {{ binhluan.capnhat|date:"d/m/Y H:i" }})</em> -->
    
    </small> 

    <p class="mt-2">
    {% if not binhluan.binhluan %}
        <em class="text-muted">[Bình luận đã bị xóa]</em>
    {% elif binhluan.binhluan|length > 20 %}
        <span id="short-{{ binhluan.id }}">{{ binhluan.binhluan|truncatechars:20 }}</span>
        <span id="full-{{ binhluan.id }}" style="display: none;">{{ binhluan.binhluan }}</span>
        <a href="#" onclick="toggleComment({{ binhluan.id }}); return false;" id="toggle-link-{{ binhluan.id }}">Xem thêm</a>
    {% else %}
        {{ binhluan.binhluan }}
    {% endif %}
</p>

    {% with binhluan.phan_hoi.all as replies %}
    {% if replies %}
        <div id="reply-list-{{ binhluan.id }}">
            {% for reply in replies|slice:":2" %}
                {% include "giaodienchung/binhluan_item1.html" with binhluan=reply user=user margin=margin|add:4 %}
            {% endfor %}
        </div>

        {% if replies|length > 2 %}
            <div id="hidden-replies-{{ binhluan.id }}" style="display: none;">
                {% for reply in replies|slice:"2:" %}
                    {% include "giaodienchung/binhluan_item1.html" with binhluan=reply user=user margin=margin|add:4 %}
                {% endfor %}
            </div>

            <a href="#" class="text-primary d-block mt-2"
               onclick="toggleReplies({{ binhluan.id }}); return false;"
               id="toggle-replies-btn-{{ binhluan.id }}"> 
                Xem thêm {{ replies|length|add:"-2" }} phản hồi…
            </a>
        {% endif %}
    {% endif %}
{% endwith %}

</div>

<script>
function toggleComment(id) {
    const shortText = document.getElementById('short-' + id);
    const fullText = document.getElementById('full-' + id);
    const link = document.getElementById('toggle-link-' + id);

    const isShortHidden = shortText.style.display === 'none';
    shortText.style.display = isShortHidden ? 'inline' : 'none';
    fullText.style.display = isShortHidden ? 'none' : 'inline';
    link.innerText = isShortHidden ? 'Xem thêm' : 'Thu gọn';
}
</script>

<script>
function toggleReplies(commentId) {
    const hidden = document.getElementById('hidden-replies-' + commentId);
    const btn = document.getElementById('toggle-replies-btn-' + commentId);

    if (!hidden) return; 

    if (hidden.style.display === 'none') {
        hidden.style.display = 'block';
        btn.textContent = 'Ẩn bớt phản hồi';
    } else {
        hidden.style.display = 'none';
        const count = hidden.children.length;
        btn.textContent = `Xem thêm ${count} phản hồi…`;
    }
}
</script>
