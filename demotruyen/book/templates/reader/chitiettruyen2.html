
{% extends 'reader/home.html' %}

{% block content %}

        <style>
            
            @media (max-width: 768px) { 
                .button-group .btn {
                    margin-bottom: 5px; /* Th√™m kho·∫£ng c√°ch nh·ªè gi·ªØa c√°c n√∫t */
                }
                .col-md-3{
                    margin-bottom: 30px;
                }
                
            }
            .dark-mode .breadcrumb-item {
                color: #fff !important; /* ƒê·ªïi m√†u ch·ªØ sang tr·∫Øng */
            }
            
               
        </style>  
               <!-- Hi·ªÉn th·ªã th√¥ng b√°o -->
    {% if messages %}
    <div class="mt-3">
        {% for message in messages %}
            <div class="alert {% if message.tags == 'success' %}alert-success{% else %}alert-danger{% endif %} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    </div>
    {% endif %}  
    
    
        <div class="container mt-4">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'reader-home' %}">Trang ch·ªß</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{{ truyen.ten_truyen }}</li>
                </ol>
            </nav>
        
            <div class="card p-4 shadow-sm bg-white">
                <div class="row">
                    <div class="col-md-3 ">
                        <img src="{{ truyen.anh_dai_dien.url }}" class="img-fluid rounded shadow" alt="{{ truyen.ten_truyen }}" style="width: 100%;" >
                    </div>
                    <div class="col-md-9">
                        <h2 class="fw-bold">{{ truyen.ten_truyen }}</h2>
                        <p><strong>C·∫≠p nh·∫≠t:</strong> {{ truyen.ngay_cap_nhat|date:"d/m/Y" }}</p>
                        <p><strong>Lo·∫°i:</strong> <span class="badge bg-primary">Truy·ªán Ch·ªØ</span></p>
                        <p><strong>T√°c gi·∫£:</strong> {{ truyen.id_tac_gia.ten_tac_gia }}</p>
                        <p><strong>Th·ªÉ lo·∫°i:</strong>
                            
                            {% with truyen.the_loai_cua_truyen.all as theloais %} <!--Kh√¥ng c·∫ßn khai b√°o b√™n views.pypy-->
                                {% if theloais %}
                                    {% for theloai_truyen in theloais %}
                                    <a href="{% url 'reader-theloai' theloai_truyen.id_the_loai.id %}" class="badge bg-info text-decoration-none" >{{ theloai_truyen.id_the_loai.ten_the_loai }}</a>{% if not forloop.last %} {% endif %}</a>
                                    <!--<span class="badge bg-info">
                                        {{ theloai_truyen.id_the_loai.ten_the_loai }}{% if not forloop.last %} {% endif %}
                                    </span> -->
                                    {% endfor %}
                                {% else %}
                                    <span class="text-muted">Ch∆∞a c√≥ th·ªÉ lo·∫°i</span>
                                {% endif %}
                                {% endwith %}
                               
                        </p>
                        <p><strong>L∆∞·ª£t xem:</strong> {{ truyen.luot_xem }}</p> <!--{{ truyen.luotxem }},{{ truyen.truyen_luot_xem.count }} -->

                        <p><strong>Y√™u th√≠ch:</strong> {{ truyen.truyen_luot_thich.count }}</p> <!--Cach 1 {{ truyen.truyen_luot_thich.count }}, C√°ch 2: VIEW.PY => so_luong_thich = ThichTruyen.objects.filter(id_truyen=truyen).count(), TEMPLATE=> {{ so_luong_thich }} -->
                        <p><strong>L∆∞·ª£t theo d√µi:</strong> {{ truyen.truyen_yeu_thich_list.count }}</p>
                        <p><strong>Tr·∫°ng th√°i:</strong> 
                            {% if truyen.trang_thai == 'hoan_thanh' %}
                                <span class="badge bg-success">Ho√†n th√†nh</span>
                            {% else %}
                                <span class="badge bg-warning">ƒêang c·∫≠p nh·∫≠t</span>
                            {% endif %}
                        </p>
                        <hr>
                        <!-- N√∫t h√†nh ƒë·ªông -->
                        <div class="mt-3 button-group">
                            <!--<button class="btn btn-outline-danger me-3"><i class="bi bi-heart"></i> Y√™u th√≠ch</button>-->

                            {% if user.is_authenticated %}
                            <form method="post" action="{% url 'toggle_thich_truyen' truyen.id %}" class="d-inline" >
                                {% csrf_token %}
                                {% if da_thich %}
                                    <button class="btn btn-danger me-3" type="submit">
                                        <i class="bi bi-heart-fill"></i> Y√™u th√≠ch
                                    </button>
                                {% else %}
                                    <button class="btn btn-outline-danger me-3" type="submit">
                                        <i class="bi bi-heart"></i> Y√™u th√≠ch
                                    </button>
                                {% endif %}
                            </form>
                            {% endif %}
                        
                        
                            <button class="btn btn-danger me-3"><i class="fas fa-heart-rate    "></i> ƒê√°nh gi√°</button>
                            <a href="{% url 'doc_tu_dau' truyen.id %}" class="btn btn-warning me-3">
                                <i class="bi bi-book"></i> ƒê·ªçc t·ª´ ƒë·∫ßu
                              </a>
                              
                              <a href="{% url 'doc_tap_moi' truyen.id %}" class="btn btn-success me-3">
                                <i class="bi bi-bookmark-check"></i> ƒê·ªçc t·∫≠p m·ªõi
                              </a>
                            <!--<button class="btn btn-primary me-3"><i class="bi bi-bell"></i> Theo d√µi</button>-->
                            {% if user.is_authenticated %}
                            <form method="post" action="{% url 'toggle_theo_doi_truyen' truyen.id %}" class="d-inline" >
                                {% csrf_token %}
                                {% if theo_doi %}
                                    <button class="btn btn-primary me-3" type="submit">
                                        <i class="bi bi-bell"></i>Theo d√µi 
                                    </button>
                                {% else %}
                                    <button class="btn btn-outline-primary me-3" type="submit">
                                        <i class="bi bi-bell"></i> Theo d√µi 
                                    </button>
                                {% endif %}
                            </form>
                            {% endif %}
                            <button class="btn btn-dark me-3"><i class="bi bi-exclamation-circle"></i> B√°o l·ªói</button>
                            <!--<button class="btn btn-dark me-3"><i class="bi bi-exclamation-circle"></i> B√°o l·ªói</button>-->
                        </div>
                        <hr>
                        <p id="mo-ta" 
                        data-full="{{ truyen.tom_tat_noi_dung|escape }}" 
                        data-short="{{ truyen.tom_tat_noi_dung|truncatechars:100|escape }}" 
                        style="max-height: 50px; overflow: hidden; transition: max-height 0.5s ease-in-out;">
                        {{ truyen.tom_tat_noi_dung|truncatechars:100 }}
                        </p>
                        <p>
                         <a id="btn-xem-them" href="javascript:void(0);" 
                            style="color: blue; text-decoration: none; font-weight: bold;">
                            Xem th√™m
                         </a>
                        </p>
                        <div class="mt-5 mb-5">
                            <button id="btn-danh-sach-chuong" class="btn btn-primary me-2 text-align-center"><i class="bi bi-list"></i> Danh s√°ch ch∆∞∆°ng</button>
                            <button id="btn-binh-luan" type="button" class="btn btn-outline-primary position-relative">
                                <i class="bi bi-chat-dots"></i> B√¨nh lu·∫≠n
                                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">{{tong_binhluan}}</span>
                            </button>
                        
        
                        </div>
                    </div>

                    <!-- üîΩ B·∫Øt ƒë·∫ßu v√πng hi·ªÉn th·ªã thay ƒë·ªïi -->
                <div id="noi-dung-doi" class="mt-4"> 
                    <!-- Ph·∫ßn b√¨nh lu·∫≠n (·∫©n m·∫∑c ƒë·ªãnh) -->
                    <div class="mt-4" id="binh-luan-section" style="display: none;">
                        <h4><i class="fa fa-comment" aria-hidden="true"></i> B√¨nh lu·∫≠n truy·ªán</h4>
                    
                        {% if user.is_authenticated %}
                            <form action="{% url 'reader-binh_luan_truyen' truyen.id%}" method="POST">
                                {% csrf_token %}
                                <textarea name="binhluan" class="form-control " rows="3" placeholder="Vi·∫øt b√¨nh lu·∫≠n c·ªßa b·∫°n..." maxlength="400" required></textarea>
                                <button type="submit" class="btn btn-primary mt-2">G·ª≠i b√¨nh lu·∫≠n</button>
                            </form>
                        {% else %}
                            <p class="text-light">B·∫°n c·∫ßn <a href="{% url 'login' %}?next={{ request.path }}">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ b√¨nh lu·∫≠n.</p>
                        {% endif %}
                    
                        <hr class="border-light">
                    
                        <h5 class="mt-4"><i class="fas fa-comments    "></i> B√¨nh lu·∫≠n m·ªõi nh·∫•t</h5>
                        {% for bl in cac_binhluan %} 
                            <!--{% if not bl.parent %}-->
                                <!--<div class="border rounded p-3 mb-3 "> -->
                                    {% include "reader/binhluan_item.html" with binhluan=bl user=user margin=0 %}
                                    <!--
                                           {% if user == bl.user %}
                                                <a href="#" onclick="toggleEditForm({{ bl.id }}); return false;">
                                                <i class="bi bi-pencil-square"></i> Ch·ªânh s·ª≠a
                                                </a>

                                                    <form id="edit-form-{{ bl.id }}" action="{% url 'sua-binh-luan' bl.id %}" method="POST" style="display: none;" class="mt-2">
                                                        {% csrf_token %}
                                                        <textarea name="noi_dung_moi" class="form-control" rows="2">{{ bl.binhluan }}</textarea>
                                                        <button type="submit" class="btn btn-sm btn-success mt-1">L∆∞u</button>
                                                    </form>
                                            {% endif %}
                                    <small class="text-muted">
                                    - {{ bl.thoigian_danhgia|date:"d/m/Y H:i" }}
                                            {% if bl.da_chinh_sua %}
                                            <em>(ƒë√£ ch·ªânh s·ª≠a)</em>
                                            {% endif %}
                                    </small>
                                    -->

                                    <!--
                                    {% if bl.user.thong_tin_nguoi_dung.anh_dai_dien %}
                                        <img src="{{ bl.user.thong_tin_nguoi_dung.anh_dai_dien.url }}" alt="·∫¢nh ƒë·∫°i di·ªán" class="img-fluid rounded-circle" width="50"> {{ bl.user.thongtinnguoidung.anh_dai_dien.url }} thongtinnguoidung l√† t√™n model ƒë∆∞·ª£c vi·∫øt th∆∞·ªùng. Django t·ª± t·∫°o t√™n quan h·ªá ng∆∞·ª£c d·∫°ng modelname (kh√¥ng c√≥ related_name).
                                    {% else %}
                                        <img src="/static/images/default-avatar.png" alt="·∫¢nh m·∫∑c ƒë·ªãnh" class="img-fluid rounded-circle" width="50">
                                     {% endif %} 
                               
                                    <strong>{{ bl.user.username }}</strong>
                                    <small class="text-muted"> - {{ bl.thoigian_danhgia|date:"d/m/Y H:i" }}</small>
                                    <p class="mt-2">{{ bl.binhluan }}</p> -->

                                    
                                <!--
                                {% if user.is_authenticated %}
                                    <a href="#" onclick="document.getElementById('reply-form-{{ bl.id }}').style.display='block'; return false;"><i class="fa fa-reply" aria-hidden="true"></i> Tr·∫£ l·ªùi</a>
                                    <div id="reply-form-{{ bl.id }}" style="display: none;" class="mt-2">
                                        <form method="POST" action="{% url 'reply-danhgia' truyen.id %}">
                                        {% csrf_token %}
                                            <input type="hidden" name="parent_id" value="{{ bl.id }}">
                                            <textarea name="binhluan" class="form-control" rows="2" placeholder="Tr·∫£ l·ªùi b√¨nh lu·∫≠n..." required></textarea>
                                            <button type="submit" class="btn btn-sm btn-primary mt-1">G·ª≠i tr·∫£ l·ªùi</button>
                                        </form>
                                    </div>
                                    
                                {% endif %}
                                -->
                                
                                 <!--
                                {% for rep in bl.phan_hoi.all %}
                                    <div class="mt-3 ms-4 p-2 border rounded bg-white" >
                                        {% if rep.user.thong_tin_nguoi_dung.anh_dai_dien %}
                                        <img src="{{ rep.user.thong_tin_nguoi_dung.anh_dai_dien.url }}" class="img-fluid rounded-circle" width="40">
                                        {% else %}
                                            <img src="/static/images/default-avatar.png" class="img-fluid rounded-circle" width="40">
                                        {% endif %}
                                            <strong>{{ rep.user.username }}</strong>
                                            <small class="text-muted"> - {{ rep.thoigian_danhgia|date:"d/m/Y H:i" }}</small>
                                            <p class="mt-2">{{ rep.binhluan }}</p>
                                    </div>
                                {% endfor %}
                                </div>
                           {% endif %}-->
                            
                        
                        {% empty %}
                            <p>Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o.</p>
                        {% endfor %} 
                    </div> 
                    

                    <div class="chapter-list border rounded p-2"  id="danh-sach-chuong" style=" max-height: 300px; overflow-y: auto; ">
                        <ul class="list-group">
                            {% for chuong in danh_sach_chuong %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <a href="{% url 'reader-docchuong' truyen.id chuong.thu_tu %}" class="text-decoration-none text-dark">
                                        üìñ Ch∆∞∆°ng {{ chuong.thu_tu }}: {{ chuong.ten_chuong }}
                                    </a>
                                    <small class="text-muted">{{ chuong.id_truyen.ngay_cap_nhat|date:"d/m/Y" }}</small>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                <!-- K·∫øt th√∫c v√πng hi·ªÉn th·ªã thay ƒë·ªïi -->
            
            
                    
                
                 
            </div>
                   
        
        </div>

        <div class="container mt-4">
            <h2 class="mb-4">Truy·ªán T∆∞∆°ng t·ª±</h2>
            
            <div class="row">
                {% for truyentt  in truyen_tuong_tu %}
                
                <div class="col-6 col-md-4 col-lg-3 mb-4" >
                     <!-- B·ªçc to√†n b·ªô card trong th·∫ª <a> -->
                    <a href="{% url 'reader-chitiettruyen' truyentt.id %}" class="text-decoration-none">
                    
                     <!-- ƒêi·ªÅu ch·ªânh s·ªë c·ªôt theo k√≠ch th∆∞·ªõc m√†n h√¨nh -->
                    <div class="card truyen-card h-100">
                        
                        <div class="position-relative">
                            
                            <img src="{{ truyentt.anh_dai_dien.url }}" class="truyen-img card-img-top" alt="{{ truyentt.ten_truyen }}">
                            
                            {% if truyentt.trang_thai == 'Full' %}
                            <span class="badge bg-danger position-absolute top-0 end-0">FULL</span>
                            {% endif %}
                        </div>
                        <div class="card-body d-flex flex-column justify-content-between">
                            <h6 class="card-title text-truncate">{{ truyentt.ten_truyen }}</h6>
                            <p class="text-muted mt-3 mb-1 small">üìñ Ch∆∞∆°ng: {{ truyentt.so_luong_chuong }}</p>
                            <p class="text-muted small">üìÖ C·∫≠p nh·∫≠t: {{ truyentt.ngay_cap_nhat|date:"d/m/Y" }}</p>
                        </div>
                    </div>
                    </a>
                </div>
                {% empty %}
                <p>Kh√¥ng c√≥ truy·ªán n√†o.</p>
                {% endfor %}
            </div>
    
        </div>
        <!-- Bootstrap 5 + Script Toggle Dark Mode -->
       
    
        <script>
            
            document.addEventListener("DOMContentLoaded", function () {
                let btn = document.getElementById("btn-xem-them");
                let moTa = document.getElementById("mo-ta");
                let isExpanded = false; // Tr·∫°ng th√°i hi·ªÉn th·ªã
            
                let fullText = moTa.getAttribute("data-full");
                let shortText = moTa.getAttribute("data-short");
            
                btn.addEventListener("click", function () {
                    if (isExpanded) {
                        moTa.innerHTML = shortText;
                        moTa.style.maxHeight = "50px"; // ƒëi·ªÅu n√†y c√≥ nghƒ©a l√† n·ªôi dung hi·ªán t·∫°i ƒëang ƒë∆∞·ª£c m·ªü r·ªông. Trong tr∆∞·ªùng h·ª£p n√†y, ƒëo·∫°n vƒÉn b·∫£n s·∫Ω ƒë∆∞·ª£c thu g·ªçn l·∫°i v·ªÅ n·ªôi dung ng·∫Øn v√† chi·ªÅu cao t·ªëi ƒëa s·∫Ω ƒë∆∞·ª£c ƒë·∫∑t l·∫°i l√† 50px. N√∫t s·∫Ω hi·ªÉn th·ªã "Xem th√™m".
                        btn.innerText = "Xem th√™m";
                    } else {
                        moTa.innerHTML = fullText;
                        moTa.style.maxHeight = "500px"; // M·ªü r·ªông
                        btn.innerText = "Thu g·ªçn";
                    }
                    isExpanded = !isExpanded; // Cu·ªëi c√πng, bi·∫øn isExpanded s·∫Ω ƒë∆∞·ª£c ƒë·∫£o ng∆∞·ª£c ƒë·ªÉ ph·∫£n √°nh tr·∫°ng th√°i m·ªõi c·ªßa n·ªôi dung (m·ªü r·ªông ho·∫∑c thu g·ªçn).
                });
            });
        </script>
        
        <!--
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const btnBinhLuan = document.getElementById('btn-binh-luan');
                const blSection = document.getElementById('binh-luan-section');
                const dsChuong = document.getElementById('danh-sach-chuong');
                const btnDanhSach = document.getElementById('btn-danh-sach-chuong');
        
                btnBinhLuan.addEventListener('click', function () {
                    if (blSection.style.display === 'none') {  //Khi ng∆∞·ªùi d√πng nh·∫•p v√†o n√∫t "B√¨nh lu·∫≠n", ph·∫ßn b√¨nh lu·∫≠n s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã (n·∫øu n√≥ ƒëang ·∫©n) v√† danh s√°ch ch∆∞∆°ng s·∫Ω b·ªã ·∫©n.
                        blSection.style.display = 'block';
                        dsChuong.style.display = 'none';
                    } else {
                        blSection.style.display = 'none';
                        dsChuong.style.display = 'block';
                    }
                });
            });
        </script>
        -->
       
       
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const btnBinhLuan = document.getElementById('btn-binh-luan');
                const btnDanhSach = document.getElementById('btn-danh-sach-chuong');
                const blSection = document.getElementById('binh-luan-section');
                const dsChuong = document.getElementById('danh-sach-chuong');

               
        
                btnBinhLuan.addEventListener('click', function () {
                    blSection.style.display = 'block'; // m·ªü ph·∫ßn b√¨nh lu·∫≠n
                    dsChuong.style.display = 'none';
                });
        
                btnDanhSach.addEventListener('click', function () {
                    blSection.style.display = 'none';
                    dsChuong.style.display = 'block';
                });
            });
        </script>

        <script>
            function toggleEditForm(id) {
            const form = document.getElementById('edit-form-' + id);
            form.style.display = (form.style.display === 'none') ? 'block' : 'none';
            }

            function toggleReplyForm(id) {
            const form = document.getElementById('reply-form-' + id);
            form.style.display = (form.style.display === 'none') ? 'block' : 'none';
            }
        </script>

<!--    Bi·ªÉu m·∫´u ch·ªânh s·ª≠a (edit-form):

ƒê∆∞·ª£c x√°c ƒë·ªãnh v·ªõi id="edit-form-{{ binhluan.id }}".
Khi ng∆∞·ªùi d√πng nh·∫•p v√†o li√™n k·∫øt "Ch·ªânh s·ª≠a", h√†m toggleEditForm({{ binhluan.id }}) s·∫Ω ƒë∆∞·ª£c g·ªçi. 
H√†m n√†y s·∫Ω ki·ªÉm tra xem bi·ªÉu m·∫´u c√≥ ƒëang hi·ªÉn th·ªã hay kh√¥ng. N·∫øu kh√¥ng, n√≥ s·∫Ω thay ƒë·ªïi style.display th√†nh 'block', l√†m cho bi·ªÉu m·∫´u hi·ªÉn th·ªã.-->


<!--
        <script>
        function toggleEditForm(id) {
        const form = document.getElementById('edit-form-' + id);
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }
        </script>
-->
      

        <!--
        <script>
                 document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("btn-xem-them");
    const moTa = document.getElementById("mo-ta");
    let isExpanded = false;

    const fullText = moTa.dataset.full;
    const shortText = moTa.dataset.short;

    const expandHeight = "500px";
    const collapseHeight = "50px";

    btn.addEventListener("click", () => {
        isExpanded = !isExpanded;
        moTa.innerHTML = isExpanded ? fullText : shortText;
        moTa.style.maxHeight = isExpanded ? expandHeight : collapseHeight;
        btn.textContent = isExpanded ? "Thu g·ªçn" : "Xem th√™m";
    });
});


        </script> -->

        
        
       
         
        <style>
            .dark-mode .chapter-list {
                background-color: #181818 !important; /* N·ªÅn x√°m than */
                color: #ffffff !important; /* Ch·ªØ tr·∫Øng */
                border-color: #444 !important; /* Vi·ªÅn t·ªëi */
            }
            
            .dark-mode .list-group-item {
                background-color: #222 !important; /* N·ªÅn item t·ªëi h∆°n */
                color: #ffffff !important; /* Ch·ªØ tr·∫Øng */
                border-color: #444 !important;
            }
            
            .dark-mode .list-group-item a {
                color: #ffffff !important; /* Ch·ªØ tr·∫Øng */
                font-weight: 500;
                text-decoration: none;
            }
            
            .dark-mode .list-group-item a:hover {
                color: #ffd700 !important; /* V√†ng khi hover */
                text-decoration: underline;
            }
            
            .dark-mode .text-muted {
                color: #aaaaaa !important; /* Ch·ªØ ph·ª• s√°ng h∆°n */
            }
            .dark-mode .form-control::placeholder,
            .dark-mode .form-control,
            .dark-mode .binh-luan-section {
                background-color: #181818; /* N·ªÅn t·ªëi cho ph·∫ßn b√¨nh lu·∫≠n */
                color: #ffffff; /* M√†u ch·ªØ s√°ng */
                color: #aaa !important; /* M√†u ch·ªØ placeholder x√°m nh·∫°t */
            }
            .dark-mode .border {
                background-color: #222; /* N·ªÅn t·ªëi cho kh·ªëi b√¨nh lu·∫≠n */
                border-color: #444; /* Vi·ªÅn t·ªëi */
            }
            .dark-mode .text-muted {
                color: #aaaaaa; /* M√†u ch·ªØ ph·ª• s√°ng h∆°n */
            }
            
        </style>
    


{% endblock %}




