{% extends 'admin/home.html' %}

{% block content %}
<div class="container" style="margin-top:75px;margin-bottom: 75px;">
    <h2 class='text-center mt-5' >Chỉnh sửa truyện</h2>

    <!-- Hiển thị thông báo -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    <form action="{% url 'suatruyen' truyen.id %}" method="POST" enctype="multipart/form-data" >
        {% csrf_token %}

        <div class="mb-3">
            <label class="form-label">Tên truyện</label>
            <input type="text" class="form-control" name="ten_truyen" value="{{ truyen.ten_truyen }}" required>
        </div>

        <div class="mb-3">
            <label class="form-label">Ảnh đại diện</label>
            <input type="file" class="form-control" name="anh_dai_dien">
            <img src="{{ truyen.anh_dai_dien.url }}" alt="Ảnh hiện tại" width="100">
        </div>

        <div class="mb-3">
            <label class="form-label">Thể Loại:</label>
            <div class="row">
            {% for tl in the_loai %}
            <div class="col-md-3">
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" name="the_loai" value="{{ tl.id }}"
                        id="theloai{{ tl.id }}"
                        {% if tl.id in the_loai_da_chon %}checked{% endif %}>
                            <label class="form-check-label" for="theloai{{ tl.id }}">
                            {{ tl.ten_the_loai }}
                            </label>
                </div>
            </div>
        {% endfor %}
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">Trạng thái</label>
            <select class="form-select" name="trang_thai">
                {% for value, label in truyen.TrangThai.choices %}
                    <option value="{{ value }}" {% if truyen.trang_thai == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3">
            <label class="form-label">Giới thiệu</label>
            <textarea class="form-control" name="gioi_thieu" rows="4" required>{{ truyen.tom_tat_noi_dung }}</textarea>
        </div>

        <h4>Chỉnh sửa chương</h4>
        {% for chuong in chuongs %}
        <div class="mb-3 chuong-truyen" id="chuong-{{ chuong.id }}">
            <label class="form-label">Tên chương {{ chuong.thu_tu }}</label>
            <input type="text" class="form-control ten-chuong" name="ten_chuong_{{ chuong.id }}" value="{{ chuong.ten_chuong }}" required>
        </div>
        <div class="mb-3">
            <label class="form-label">Nội dung chương {{ chuong.thu_tu }}</label>
            <textarea class="form-control noi-dung-chuong" name="noi_dung_chuong_{{ chuong.id }}" required>{{ chuong.noi_dung_chuong }}</textarea>
            <button type="button" class="btn btn-warning btn-xoa-chuong mt-1" data-id="{{ chuong.id }}">Xóa</button>
        </div>
        {% endfor %}
        <input type="hidden" name="chuong_xoa" id="chuong-xoa" value="">

        <h4>Thêm chương mới</h4>
        <div id="them-chuong-moi"></div>
            <button type="button" class="btn btn-danger mt-3 me-5" id="btn-them-chuong">Thêm chương</button>
                <input type="hidden" name="so_chuong_moi" id="so-chuong-moi" value="0">
            <button type="submit" class="btn btn-primary mt-3">Lưu thay đổi</button>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.getElementById("btn-them-chuong").addEventListener("click", function() {
        let soChuongMoi = parseInt(document.getElementById("so-chuong-moi").value) + 1;
        document.getElementById("so-chuong-moi").value = soChuongMoi;
        let newChapter = document.createElement("div");
        newChapter.classList.add("mb-3", "chuong-truyen");
        newChapter.setAttribute("id", `chuong-moi-${soChuongMoi}`);
        newChapter.innerHTML = `
            <label class="form-label">Tên chương mới ${soChuongMoi}</label>
            <input type="text" class="form-control ten-chuong" name="ten_chuong_moi_${soChuongMoi}" required>
            <label class="form-label">Nội dung chương mới ${soChuongMoi}</label>
            <textarea class="form-control noi-dung-chuong" name="noi_dung_chuong_moi_${soChuongMoi}" required></textarea>
            <button type="button" class="btn btn-success mt-1 btn-xoa-chuong-moi" data-id="${soChuongMoi}">Xóa</button>
        `;
    
       document.getElementById("them-chuong-moi").appendChild(newChapter);
    });
    
    // Xử lý xóa chương đã có trong DB
    document.querySelectorAll(".btn-xoa-chuong").forEach(button => {
        button.addEventListener("click", function() {
            let chuongId = this.getAttribute("data-id");
            let chuongElement = document.getElementById(`chuong-${chuongId}`);
    
            if (chuongElement) {
                chuongElement.nextElementSibling?.remove(); // Xóa textarea nội dung chương
                chuongElement.remove(); // Xóa phần tên chương
            }
    
            let chuongXoaInput = document.getElementById("chuong-xoa");
            chuongXoaInput.value += chuongId + ",";
        });
    });
    
    
    // Xử lý xóa chương mới
    document.getElementById("them-chuong-moi").addEventListener("click", function(event) {
        if (event.target.classList.contains("btn-xoa-chuong-moi")) {
            let chuongId = event.target.getAttribute("data-id");
            let chuongElement = document.getElementById(`chuong-moi-${chuongId}`);
            
            if (chuongElement) {
                chuongElement.remove(); // Xóa chương khỏi DOM
                
                // Giảm số chương mới xuống
                let soChuongMoi = parseInt(document.getElementById("so-chuong-moi").value);
                document.getElementById("so-chuong-moi").value = Math.max(soChuongMoi - 1, 0);
            }
        }
    });
    
    
    document.querySelector("form").addEventListener("submit", function(event) {
        let chuongInputs = document.querySelectorAll("[name^='ten_chuong_moi_']");
        let noiDungInputs = document.querySelectorAll("[name^='noi_dung_chuong_moi_']");
        for (let i = 0; i < chuongInputs.length; i++) {
            if (!chuongInputs[i].value.trim() || !noiDungInputs[i].value.trim()) {
                alert("Vui lòng điền đầy đủ tên và nội dung chương mới.");
                event.preventDefault();
                return;
            }
        }
    });
    
    
</script>

<style>
    /* Input field for chapter title */
    .ten-chuong {
        width: 100%; /* or a fixed width like 400px */
        max-width: 1200px; /* limit max width for large screens */
        height: 44px; /* standard height for single line */
        padding: 0.5rem; /* padding for comfort */
        font-size: 1rem; /* font size */
        border: 1px solid #d1d5db; /* light gray border */
        border-radius: 0.5rem; /* rounded corners */
        transition: border-color 0.3s ease; /* smooth transition */
    }
    .ten-chuong:focus {
        border-color: #2563eb; /* blue focus border */
        outline: none; /* remove default outline */
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.3); /* subtle shadow */
    }
    /* Textarea for chapter content with fixed 500px height */
    .noi-dung-chuong {
        width: 100%; /* or a fixed width like 400px */
        max-width: 1200px; /* limit max width for large screens */
        height: 500px; /* fixed height for multi-line input */
        padding: 0.75rem; /* padding for comfort */
        font-size: 1rem; /* font size */
        border: 1px solid #d1d5db; /* light gray border */
        border-radius: 0.5rem; /* rounded corners */
        resize: none; /* disable resizing */
        transition: border-color 0.3s ease; /* smooth transition */
    }
    .noi-dung-chuong:focus {
        border-color: #2563eb; /* blue focus border */
        outline: none; /* remove default outline */
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.3); /* subtle shadow */
    }
</style>

{% endblock %}
